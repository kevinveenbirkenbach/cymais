- name: "recieve certbot certificate for {{ domain }}"
  command: >-
    certbot certonly --agree-tos --email {{ administrator_email }}
    --non-interactive --webroot -w /var/lib/letsencrypt/ -d {{ domain }}
    {{ '--test-cert' if mode_test | bool else '' }}
  when: not enable_wildcard_certificate | bool or primary_domain not in domain

- name: "recieve certbot certificate for *{{ primary_domain }}"
  command: >-
    certbot certonly --agree-tos --email {{ administrator_email }}
    --non-interactive --webroot -w /var/lib/letsencrypt/ -d {{ primary_domain }} -d *.{{ primary_domain }}
    {{ '--test-cert' if mode_test | bool else '' }}
  when: 
    - enable_wildcard_certificate | bool
    - primary_domain in domain
    - run_once_recieve_certificate is not defined

- name: "Cleanup dedicated cert for {{ domain }}"
  command: >-
    certbot delete --cert-name {{ domain }} --non-interactive
  when: 
    - mode_cleanup | bool
    - enable_wildcard_certificate | bool
    - primary_domain in domain
    - domain != primary_domain
  ignore_errors: true

- name: run the recieve_certificate tasks once
  set_fact:
    run_once_recieve_certificate: true
  when: run_once_recieve_certificate is not defined