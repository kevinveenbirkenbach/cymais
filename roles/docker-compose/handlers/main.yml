---
- name: Validate Docker Compose configuration
  command:
    cmd: docker compose -f {{ docker_compose.files.docker_compose }} config --quiet
    chdir: "{{ docker_compose.directories.instance }}"
  register: dc_validate
  changed_when: false
  failed_when: dc_validate.rc != 0
  listen:
    - docker compose up
    - docker compose restart

- name: Build docker 
  command:
    cmd:   docker compose build
    chdir: "{{docker_repository_path}}"
  environment:
    COMPOSE_HTTP_TIMEOUT: 600
    DOCKER_CLIENT_TIMEOUT: 600
  listen: 
    - docker compose build
    - docker compose up     # This is just here because I didn't took the time to refactor
                            # @todo go over all docker compose up implementations and check where it makes sense to user docker compose build and where docker compose up
  when: application_id != 'web-app-bigbluebutton' # @todo solve this on a different way, just a fast hack

- name: docker compose up
  shell: docker-compose -p {{ application_id | get_entity_name }} up -d --force-recreate --remove-orphans
  args:
    chdir: "{{ docker_compose.directories.instance }}"
    executable: /bin/bash
  environment:
    COMPOSE_HTTP_TIMEOUT: 600
    DOCKER_CLIENT_TIMEOUT: 600
  listen: docker compose up

- name: docker compose restart
  command:
    cmd: "docker compose restart"
    chdir: "{{docker_compose.directories.instance}}"
  listen: docker compose restart
