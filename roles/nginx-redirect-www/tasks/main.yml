---
- name: "Debug: all_domains"
  debug:
    var: all_domains
  when: enable_debug

- name: Filter www-prefixed domains from all_domains
  set_fact:
    www_domains: "{{ all_domains | select('match', '^www\\.') | list }}"

- name: Include nginx-redirect-domain role for www-to-bare redirects
  include_role:
    name: nginx-redirect-domain
  vars:
    domain_mappings: "{{ www_domains
       | map('regex_replace',
             '^www\\.(.+)$',
             '{ source: \"www.\\1\", target: \"\\1\" }')
       | map('from_yaml')
       | list
    }}"

- name: Include DNS role to set redirects
  include_role:
    name: dns-records-cloudflare
  vars:
    cloudflare_api_token:     "{{ certbot_dns_api_token }}"
    cloudflare_domains:       "{{ www_domains }}"
    cloudflare_target_ip:     "{{ networks.internet.ip4 }}"
    cloudflare_proxied:       false
  when: dns_provider == 'cloudflare'