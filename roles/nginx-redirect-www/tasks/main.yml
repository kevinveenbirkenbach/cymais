---
# 1. Filter all domains with the “www.” prefix
- name: Filter www-prefixed domains from all_domains
  set_fact:
    www_domains: "{{ all_domains | select('match', '^www\\.') | list }}"

# 2. Build redirect mappings (www.domain → domain)
- name: Build redirect mappings for www domains
  set_fact:
    domain_mappings: >-
      {{ www_domains
         | map('regex_replace', '^www\\.(.+)$', '{ source: \"www.\\1\", target: \"\\1\" }')
         | map('from_yaml')
         | list
      }}

# 3. Include the nginx-redirect-domain role to apply these mappings
- name: Include nginx-redirect-domain role for www-to-bare redirects
  include_role:
    name: nginx-redirect-domain
  vars:
    domain_mappings: "{{ domain_mappings }}"
  when: certbot_flavor == 'dedicated'
