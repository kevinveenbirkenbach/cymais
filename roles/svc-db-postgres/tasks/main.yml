- block:
  - name: Create Docker network for PostgreSQL
    docker_network:
      name: "{{ postgres_network_name }}"
      state: present
      ipam_config:
        - subnet: "{{ postgres_subnet }}"

  - name: "include docker-compose role"
    include_role: 
      name: docker-compose

  - name: Wait for Postgres inside the container
    shell: "docker exec {{ postgres_name }} pg_isready -U postgres"
    register: pg_ready
    until: pg_ready.rc == 0
    retries: 30
    delay: 5

  - name: install python-psycopg2
    pacman: 
      name: python-psycopg2
      state: present
      
  - include_tasks: utils/run_once.yml
  when: run_once_svc_db_postgres is not defined

- name: "Ensure that {{ docker_compose.directories.instance }} is up"
  include_tasks: "{{ playbook_dir }}/roles/docker-compose/tasks/helpers/ensure.yml"

- name: "Initialize database for '{{ database_name }}'"
  include_tasks: init.yml
  when: "{{ postgres_init }}"