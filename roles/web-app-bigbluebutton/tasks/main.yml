---
- name: "For '{{ application_id }}': include docker-compose role"
  include_role:
    name: cmp-docker-proxy
  vars:
    database_instance:  "{{ application_id }}"
    database_password:  "{{ applications | get_app_conf(application_id, 'credentials.postgresql_secret', True) }}"
    database_username:  "postgres"
    database_name:      ""                              # Multiple databases

- name: configure websocket_upgrade.conf
  copy: 
    src:  "websocket_upgrade.conf"
    dest: "{{nginx.directories.http.maps}}websocket_upgrade.conf"
  notify: restart nginx

- name: "Set BBB Facts"
  set_fact:
    bbb_env_file_link:            "{{ docker_repository_path }}.env"
    bbb_env_file_origine:         "{{ docker_compose.files.env }}"
    docker_compose_file_origine:  "{{ docker_repository_path }}docker-compose.yml"
    docker_compose_file_final:    "{{ docker_compose.directories.instance }}docker-compose.yml"

- name: deploy .env
  template: 
    src:  env.j2
    dest: "{{ bbb_env_file_origine }}"

- name: Create symbolic link from .env file to target location
  file:
    src:    "{{ bbb_env_file_origine }}"
    dest:   "{{ bbb_env_file_link }}"
    state:  link

- name: "Setup docker-compose.yml file"
  include_tasks: "docker-compose.yml"

- name: flush docker service
  meta: flush_handlers

- name: Wait for BigBlueButton
  wait_for:
    host: "{{ domains | get_domain('web-app-bigbluebutton') }}"
    port: 80
    delay: 5
    timeout: 300

- name: create admin
  command:
    cmd: docker compose exec greenlight bundle exec rake admin:create
    chdir: "{{ docker_compose.directories.instance }}"
  when: bbb_setup
  ignore_errors: true
  register: admin_creation_result